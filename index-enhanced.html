<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>신오쿠보 스마트 가이드 - AI 맛집 추천</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
        }
        
        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            --glass-bg: rgba(0, 0, 0, 0.05);
            --glass-border: rgba(0, 0, 0, 0.1);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
        }
        
        body {
            font-family: 'Noto Sans KR', 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .glass-morphism {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }
        
        .neon-border {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .floating-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
            50% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.6); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        #map {
            height: 400px;
            border-radius: 16px;
            z-index: 1;
        }
        
        .restaurant-marker {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .top-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
        }
        
        [data-theme="light"] .top-overlay {
            background: rgba(255, 255, 255, 0.9);
        }
        
        .side-panel {
            position: fixed;
            right: 10px;
            top: 120px;
            width: 280px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 999;
        }
        
        @media (max-width: 768px) {
            .side-panel {
                position: relative;
                right: auto;
                top: auto;
                width: 100%;
                max-height: none;
                margin-top: 20px;
            }
        }
        
        .restaurant-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .restaurant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .language-btn {
            transition: all 0.3s ease;
        }
        
        .language-btn:hover {
            transform: scale(1.1);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .voice-btn {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .review-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }
        
        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 24px;
        }
        
        .star-rating .star {
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }
        
        .star-rating .star.active {
            color: #ffd700;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Top Overlay with Stats -->
    <div class="top-overlay">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center space-x-4">
                    <h1 class="font-bold text-lg">
                        <i class="fas fa-utensils mr-2"></i>
                        <span id="app-title">신오쿠보 스마트 가이드</span>
                    </h1>
                    <div class="loading-spinner" id="loading-indicator" style="display: none;"></div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="p-2 rounded-lg glass-morphism" onclick="toggleTheme()">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                    
                    <!-- Voice Search -->
                    <button id="voice-search" class="p-2 rounded-lg glass-morphism voice-btn" onclick="startVoiceSearch()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <!-- Location -->
                    <button id="location-btn" class="p-2 rounded-lg glass-morphism" onclick="getCurrentLocation()">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                    
                    <!-- Language Selector -->
                    <div class="flex space-x-1">
                        <button class="language-btn px-2 py-1 text-xs bg-blue-500 text-white rounded" onclick="changeLanguage('ko')">한</button>
                        <button class="language-btn px-2 py-1 text-xs bg-gray-600 text-white rounded" onclick="changeLanguage('en')">EN</button>
                        <button class="language-btn px-2 py-1 text-xs bg-gray-600 text-white rounded" onclick="changeLanguage('ja')">日</button>
                        <button class="language-btn px-2 py-1 text-xs bg-gray-600 text-white rounded" onclick="changeLanguage('zh')">中</button>
                        <button class="language-btn px-2 py-1 text-xs bg-gray-600 text-white rounded" onclick="changeLanguage('th')">ไทย</button>
                        <button class="language-btn px-2 py-1 text-xs bg-gray-600 text-white rounded" onclick="changeLanguage('vi')">VI</button>
                    </div>
                </div>
            </div>
            
            <!-- Stats Charts -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-morphism p-3">
                    <canvas id="categoryChart" style="height: 80px;"></canvas>
                </div>
                <div class="glass-morphism p-3">
                    <canvas id="ratingChart" style="height: 80px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pt-40 pb-6">
        <div class="container mx-auto px-4">
            <!-- Search Bar -->
            <div class="mb-6">
                <div class="glass-morphism p-4">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="search-input" class="flex-1 px-4 py-2 bg-transparent border-b border-gray-400 focus:outline-none" placeholder="맛집 검색...">
                        <button onclick="searchRestaurants()" class="px-4 py-2 bg-blue-500 text-white rounded-lg">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Map Section -->
                <div class="lg:col-span-2">
                    <div class="glass-morphism p-4 neon-border floating-animation">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-semibold text-lg">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span id="map-title">실시간 인기 맛집 지도</span>
                            </h2>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 bg-green-500 text-white rounded-lg text-sm pulse-glow" onclick="refreshData()">
                                    <i class="fas fa-sync-alt mr-1"></i>
                                    <span id="refresh-btn">새로고침</span>
                                </button>
                                <select id="filter-select" class="px-2 py-1 bg-gray-700 text-white rounded-lg text-sm" onchange="filterRestaurants()">
                                    <option value="all">전체</option>
                                    <option value="korean">한식</option>
                                    <option value="bbq">고기</option>
                                    <option value="cafe">카페</option>
                                    <option value="street">분식</option>
                                </select>
                            </div>
                        </div>
                        <div id="map"></div>
                        
                        <!-- Distance from current location -->
                        <div id="distance-info" class="mt-2 text-sm text-gray-300" style="display: none;">
                            <i class="fas fa-route mr-1"></i>
                            <span id="distance-text"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Side Panel - Top 10 Restaurants -->
                <div class="lg:col-span-1">
                    <div class="glass-morphism p-4 side-panel lg:relative lg:right-auto lg:top-auto lg:w-auto">
                        <h3 class="font-semibold text-lg mb-4 relative">
                            <i class="fas fa-fire mr-2 text-orange-500"></i>
                            <span id="top10-title">실시간 인기 TOP 10</span>
                            <span class="notification-badge" id="update-badge" style="display: none;">!</span>
                        </h3>
                        <div id="top-restaurants" class="space-y-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- Additional Info Section -->
            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Social Media Activity -->
                <div class="glass-morphism p-4">
                    <h3 class="font-semibold mb-4">
                        <i class="fab fa-twitter mr-2 text-blue-400"></i>
                        <span id="social-title">소셜미디어 실시간 동향</span>
                    </h3>
                    <div id="social-feed" class="space-y-2"></div>
                </div>
                
                <!-- AI Recommendations -->
                <div class="glass-morphism p-4">
                    <h3 class="font-semibold mb-4">
                        <i class="fas fa-robot mr-2 text-purple-400"></i>
                        <span id="ai-title">AI 맞춤 추천</span>
                    </h3>
                    <div id="ai-recommendations" class="space-y-2"></div>
                </div>
                
                <!-- User Reviews -->
                <div class="glass-morphism p-4">
                    <h3 class="font-semibold mb-4">
                        <i class="fas fa-star mr-2 text-yellow-400"></i>
                        <span id="reviews-title">최근 리뷰</span>
                    </h3>
                    <div id="recent-reviews" class="space-y-2"></div>
                    <button onclick="openReviewModal()" class="w-full mt-3 px-3 py-2 bg-blue-500 text-white rounded-lg text-sm">
                        <i class="fas fa-pen mr-1"></i>
                        <span id="write-review-btn">리뷰 작성</span>
                    </button>
                </div>
            </div>
            
            <!-- Business Contact -->
            <div class="mt-8">
                <div class="glass-morphism p-4 text-center">
                    <h4 class="font-semibold mb-2">
                        <i class="fas fa-handshake mr-2"></i>
                        <span id="partnership-title">업무 제휴 문의</span>
                    </h4>
                    <p class="text-gray-300">
                        <i class="fas fa-envelope mr-2"></i>
                        <a href="mailto:shin.jeiths@gmail.com" class="text-blue-300 hover:text-blue-100">shin.jeiths@gmail.com</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="review-modal" style="display: none;">
        <div class="modal-backdrop" onclick="closeReviewModal()"></div>
        <div class="review-modal glass-morphism p-6">
            <h3 class="text-xl font-bold mb-4">리뷰 작성</h3>
            <div class="mb-4">
                <label class="block mb-2">음식점 선택</label>
                <select id="review-restaurant" class="w-full px-3 py-2 bg-gray-700 text-white rounded-lg">
                    <option value="">선택하세요</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block mb-2">평점</label>
                <div class="star-rating" id="star-rating">
                    <span class="star" data-rating="1">★</span>
                    <span class="star" data-rating="2">★</span>
                    <span class="star" data-rating="3">★</span>
                    <span class="star" data-rating="4">★</span>
                    <span class="star" data-rating="5">★</span>
                </div>
            </div>
            <div class="mb-4">
                <label class="block mb-2">리뷰 내용</label>
                <textarea id="review-content" rows="4" class="w-full px-3 py-2 bg-gray-700 text-white rounded-lg"></textarea>
            </div>
            <div class="flex space-x-2">
                <button onclick="submitReview()" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg">
                    <i class="fas fa-paper-plane mr-1"></i> 제출
                </button>
                <button onclick="closeReviewModal()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg">
                    <i class="fas fa-times mr-1"></i> 취소
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered:', registration))
                .catch(error => console.log('SW registration failed:', error));
        }

        // Multi-language support (Enhanced with Vietnamese)
        const translations = {
            ko: {
                'app-title': '신오쿠보 스마트 가이드',
                'map-title': '실시간 인기 맛집 지도',
                'refresh-btn': '새로고침',
                'top10-title': '실시간 인기 TOP 10',
                'social-title': '소셜미디어 실시간 동향',
                'ai-title': 'AI 맞춤 추천',
                'reviews-title': '최근 리뷰',
                'write-review-btn': '리뷰 작성',
                'partnership-title': '업무 제휴 문의',
                'search-placeholder': '맛집 검색...'
            },
            en: {
                'app-title': 'Shin-Okubo Smart Guide',
                'map-title': 'Real-time Popular Restaurant Map',
                'refresh-btn': 'Refresh',
                'top10-title': 'Real-time Top 10',
                'social-title': 'Social Media Live Feed',
                'ai-title': 'AI Recommendations',
                'reviews-title': 'Recent Reviews',
                'write-review-btn': 'Write Review',
                'partnership-title': 'Business Partnership',
                'search-placeholder': 'Search restaurants...'
            },
            ja: {
                'app-title': '新大久保スマートガイド',
                'map-title': 'リアルタイム人気店マップ',
                'refresh-btn': '更新',
                'top10-title': 'リアルタイムTOP 10',
                'social-title': 'ソーシャル動向',
                'ai-title': 'AI おすすめ',
                'reviews-title': '最近のレビュー',
                'write-review-btn': 'レビューを書く',
                'partnership-title': 'ビジネス提携',
                'search-placeholder': 'レストラン検索...'
            },
            zh: {
                'app-title': '新大久保智能指南',
                'map-title': '实时热门餐厅地图',
                'refresh-btn': '刷新',
                'top10-title': '实时热门TOP 10',
                'social-title': '社交媒体动态',
                'ai-title': 'AI 推荐',
                'reviews-title': '最近评论',
                'write-review-btn': '写评论',
                'partnership-title': '商务合作',
                'search-placeholder': '搜索餐厅...'
            },
            th: {
                'app-title': 'คู่มือชิน-โอคุโบะ',
                'map-title': 'แผนที่ร้านอาหารยอดนิยม',
                'refresh-btn': 'รีเฟรช',
                'top10-title': 'ยอดนิยม TOP 10',
                'social-title': 'โซเชียลมีเดียสด',
                'ai-title': 'แนะนำโดย AI',
                'reviews-title': 'รีวิวล่าสุด',
                'write-review-btn': 'เขียนรีวิว',
                'partnership-title': 'ติดต่อธุรกิจ',
                'search-placeholder': 'ค้นหาร้านอาหาร...'
            },
            vi: {
                'app-title': 'Hướng dẫn Shin-Okubo',
                'map-title': 'Bản đồ nhà hàng phổ biến',
                'refresh-btn': 'Làm mới',
                'top10-title': 'Top 10 phổ biến',
                'social-title': 'Mạng xã hội trực tiếp',
                'ai-title': 'Đề xuất AI',
                'reviews-title': 'Đánh giá gần đây',
                'write-review-btn': 'Viết đánh giá',
                'partnership-title': 'Hợp tác kinh doanh',
                'search-placeholder': 'Tìm kiếm nhà hàng...'
            }
        };

        // Enhanced restaurant data with more dynamic properties
        let restaurants = [
            {
                id: 1,
                name: '화촌 삼겹살',
                nameEn: 'Hwachon BBQ',
                nameJa: 'ファチョン焼肉',
                category: 'bbq',
                rating: 4.8,
                reviews: 1245,
                lat: 35.7040,
                lng: 139.7052,
                socialScore: 95,
                trending: true,
                distance: null,
                userReviews: [],
                lastUpdate: Date.now()
            },
            {
                id: 2,
                name: '백종원의 본가',
                nameEn: 'Paik Jong Won',
                nameJa: 'ペクチョンウォンの本家',
                category: 'korean',
                rating: 4.6,
                reviews: 892,
                lat: 35.7038,
                lng: 139.7048,
                socialScore: 88,
                trending: true,
                distance: null,
                userReviews: [],
                lastUpdate: Date.now()
            },
            {
                id: 3,
                name: '신전떡볶이',
                nameEn: 'Shinjeon Tteokbokki',
                nameJa: '神田トッポッキ',
                category: 'street',
                rating: 4.4,
                reviews: 567,
                lat: 35.7042,
                lng: 139.7055,
                socialScore: 82,
                trending: false,
                distance: null,
                userReviews: [],
                lastUpdate: Date.now()
            },
            {
                id: 4,
                name: '신촌카페',
                nameEn: 'Sinchon Cafe',
                nameJa: '新村カフェ',
                category: 'cafe',
                rating: 4.7,
                reviews: 734,
                lat: 35.7036,
                lng: 139.7050,
                socialScore: 79,
                trending: true,
                distance: null,
                userReviews: [],
                lastUpdate: Date.now()
            },
            {
                id: 5,
                name: '막걸리 모노가타리',
                nameEn: 'Makgeolli Story',
                nameJa: 'マッコリものがたり',
                category: 'korean',
                rating: 4.5,
                reviews: 445,
                lat: 35.7044,
                lng: 139.7053,
                socialScore: 75,
                trending: false,
                distance: null,
                userReviews: [],
                lastUpdate: Date.now()
            }
        ];

        let map;
        let markers = [];
        let currentLanguage = 'ko';
        let userLocation = null;
        let selectedRating = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadUserPreferences();
            initMap();
            initCharts();
            updateTopRestaurants();
            updateSocialFeed();
            updateAIRecommendations();
            updateRecentReviews();
            setupStarRating();
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Auto refresh every 30 seconds
            setInterval(() => {
                refreshData();
                checkForUpdates();
            }, 30000);
            
            // Load saved reviews from localStorage
            loadSavedReviews();
        });

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon').className = newTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            
            // Save preference
            localStorage.setItem('theme', newTheme);
        }

        // Load user preferences
        function loadUserPreferences() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            
            const savedLanguage = localStorage.getItem('language') || 'ko';
            changeLanguage(savedLanguage);
        }

        // Voice search
        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('음성 검색은 Chrome 브라우저에서만 사용 가능합니다.');
                return;
            }
            
            const recognition = new webkitSpeechRecognition();
            recognition.lang = currentLanguage === 'ko' ? 'ko-KR' : 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = () => {
                document.getElementById('voice-search').classList.add('text-red-500');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('search-input').value = transcript;
                searchRestaurants();
            };
            
            recognition.onerror = (event) => {
                console.error('Voice recognition error:', event.error);
            };
            
            recognition.onend = () => {
                document.getElementById('voice-search').classList.remove('text-red-500');
            };
            
            recognition.start();
        }

        // Get current location
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('위치 서비스를 사용할 수 없습니다.');
                return;
            }
            
            document.getElementById('location-btn').classList.add('text-blue-500');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Add user marker to map
                    const userMarker = L.marker([userLocation.lat, userLocation.lng], {
                        icon: L.divIcon({
                            className: 'user-location',
                            html: '<div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    
                    userMarker.bindPopup('현재 위치').openPopup();
                    
                    // Calculate distances
                    calculateDistances();
                    
                    // Center map on user location
                    map.setView([userLocation.lat, userLocation.lng], 16);
                    
                    document.getElementById('location-btn').classList.remove('text-blue-500');
                },
                (error) => {
                    console.error('Location error:', error);
                    alert('위치를 가져올 수 없습니다.');
                    document.getElementById('location-btn').classList.remove('text-blue-500');
                }
            );
        }

        // Calculate distances from user location
        function calculateDistances() {
            if (!userLocation) return;
            
            restaurants.forEach(restaurant => {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    restaurant.lat, restaurant.lng
                );
                restaurant.distance = distance;
            });
            
            // Update display
            updateTopRestaurants();
        }

        // Haversine formula for distance calculation
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c * 1000).toFixed(0); // Distance in meters
        }

        // Search restaurants
        function searchRestaurants() {
            const query = document.getElementById('search-input').value.toLowerCase();
            
            if (!query) {
                updateMapMarkers();
                return;
            }
            
            const filtered = restaurants.filter(r => 
                r.name.toLowerCase().includes(query) ||
                r.nameEn.toLowerCase().includes(query) ||
                r.nameJa.toLowerCase().includes(query) ||
                r.category.includes(query)
            );
            
            // Clear and update markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            filtered.forEach(restaurant => {
                addMarkerToMap(restaurant);
            });
            
            // Show notification if no results
            if (filtered.length === 0) {
                showNotification('검색 결과가 없습니다.');
            }
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([35.7040, 139.7051], 17);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            updateMapMarkers();
        }

        // Add marker to map
        function addMarkerToMap(restaurant) {
            const icon = L.divIcon({
                className: 'restaurant-marker',
                html: `<div style="width: 30px; height: 30px; background: ${restaurant.trending ? 'linear-gradient(45deg, #ff6b6b, #4ecdc4)' : 'linear-gradient(45deg, #a0a0a0, #707070)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">${restaurant.socialScore}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([restaurant.lat, restaurant.lng], {icon: icon})
                .bindPopup(`
                    <div class="p-3">
                        <h3 class="font-bold text-lg mb-2">${restaurant.name}</h3>
                        <div class="flex items-center mb-2">
                            <span class="text-yellow-400">${'★'.repeat(Math.floor(restaurant.rating))}</span>
                            <span class="ml-2">${restaurant.rating} (${restaurant.reviews})</span>
                        </div>
                        <div class="mb-2">
                            <span class="inline-block px-2 py-1 bg-blue-500 text-white rounded-full text-xs">${restaurant.category}</span>
                            ${restaurant.trending ? '<span class="inline-block px-2 py-1 bg-red-500 text-white rounded-full text-xs ml-1">HOT</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-300">
                            소셜 점수: ${restaurant.socialScore}/100
                            ${restaurant.distance ? `<br>거리: ${restaurant.distance}m` : ''}
                        </div>
                    </div>
                `);
            
            markers.push(marker);
            marker.addTo(map);
        }

        // Update map markers
        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add new markers
            restaurants.forEach(restaurant => {
                addMarkerToMap(restaurant);
            });
        }

        // Initialize charts
        function initCharts() {
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categoryData = {
                korean: restaurants.filter(r => r.category === 'korean').length,
                bbq: restaurants.filter(r => r.category === 'bbq').length,
                cafe: restaurants.filter(r => r.category === 'cafe').length,
                street: restaurants.filter(r => r.category === 'street').length
            };
            
            new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: ['한식', '고기', '카페', '분식'],
                    datasets: [{
                        data: [categoryData.korean, categoryData.bbq, categoryData.cafe, categoryData.street],
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            display: false,
                            beginAtZero: true 
                        },
                        x: { 
                            ticks: { color: 'white', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Rating Chart
            const ratingCtx = document.getElementById('ratingChart').getContext('2d');
            new Chart(ratingCtx, {
                type: 'bar',
                data: {
                    labels: ['4.0+', '4.3+', '4.6+', '4.8+'],
                    datasets: [{
                        data: [
                            restaurants.filter(r => r.rating >= 4.0).length,
                            restaurants.filter(r => r.rating >= 4.3).length,
                            restaurants.filter(r => r.rating >= 4.6).length,
                            restaurants.filter(r => r.rating >= 4.8).length
                        ],
                        backgroundColor: ['#ffd93d', '#6bcf7f', '#4d96ff', '#ff6b6b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            display: false,
                            beginAtZero: true 
                        },
                        x: { 
                            ticks: { color: 'white', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Update top restaurants
        function updateTopRestaurants() {
            let sortedRestaurants = [...restaurants];
            
            // Sort by distance if user location is available
            if (userLocation) {
                sortedRestaurants.sort((a, b) => {
                    if (a.distance && b.distance) {
                        return a.distance - b.distance;
                    }
                    return b.socialScore - a.socialScore;
                });
            } else {
                sortedRestaurants.sort((a, b) => b.socialScore - a.socialScore);
            }
            
            sortedRestaurants = sortedRestaurants.slice(0, 10);
            
            const container = document.getElementById('top-restaurants');
            container.innerHTML = '';
            
            sortedRestaurants.forEach((restaurant, index) => {
                const card = document.createElement('div');
                card.className = 'restaurant-card glass-morphism p-3 slide-in';
                card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                ${index + 1}
                            </div>
                            <div>
                                <h4 class="font-medium text-sm">${restaurant.name}</h4>
                                <div class="flex items-center text-xs text-gray-300">
                                    <span class="text-yellow-400">★${restaurant.rating}</span>
                                    <span class="ml-2">(${restaurant.reviews})</span>
                                    ${restaurant.distance ? `<span class="ml-2">📍 ${restaurant.distance}m</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-green-400 font-bold text-sm">${restaurant.socialScore}</div>
                            ${restaurant.trending ? '<div class="text-red-400 text-xs">🔥 HOT</div>' : ''}
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    map.setView([restaurant.lat, restaurant.lng], 19);
                    markers.find(m => m.getLatLng().lat === restaurant.lat)?.openPopup();
                });
                
                container.appendChild(card);
            });
        }

        // Enhanced social feed with more dynamic content
        function updateSocialFeed() {
            const platforms = ['twitter', 'facebook', 'instagram'];
            const hashtags = ['#신오쿠보맛집', '#ShinOkubo', '#新大久保グルメ', '#코리아타운'];
            const times = ['방금', '2분 전', '5분 전', '10분 전', '15분 전'];
            
            const socialPosts = [];
            
            // Generate more dynamic social posts
            for (let i = 0; i < 5; i++) {
                const restaurant = restaurants[Math.floor(Math.random() * restaurants.length)];
                const platform = platforms[Math.floor(Math.random() * platforms.length)];
                const hashtag = hashtags[Math.floor(Math.random() * hashtags.length)];
                const time = times[i];
                
                socialPosts.push({
                    platform: platform,
                    text: `${restaurant.name}에서 ${['점심', '저녁', '브런치'][Math.floor(Math.random() * 3)]} 먹었는데 정말 맛있어요! ${hashtag}`,
                    time: time,
                    engagement: Math.floor(Math.random() * 100) + 10,
                    restaurant: restaurant.name
                });
            }
            
            const container = document.getElementById('social-feed');
            container.innerHTML = '';
            
            socialPosts.forEach((post, index) => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-gray-800 p-3 rounded-lg slide-in';
                postElement.style.animationDelay = `${index * 0.2}s`;
                postElement.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <i class="fab fa-${post.platform} text-${post.platform === 'twitter' ? 'blue-400' : post.platform === 'facebook' ? 'blue-600' : 'pink-500'} mt-1"></i>
                        <div class="flex-1">
                            <p class="text-sm">${post.text}</p>
                            <div class="flex items-center justify-between mt-2 text-xs text-gray-400">
                                <span>${post.time}</span>
                                <span>❤️ ${post.engagement}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(postElement);
            });
        }

        // Enhanced AI recommendations with user preferences
        function updateAIRecommendations() {
            const userPreferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
            const visitHistory = JSON.parse(localStorage.getItem('visitHistory') || '[]');
            
            const recommendations = [];
            
            // Time-based recommendations
            const hour = new Date().getHours();
            if (hour < 11) {
                recommendations.push({
                    type: '아침 추천',
                    text: '신촌카페의 모닝 세트가 인기입니다',
                    confidence: 92,
                    reason: '시간대 기반'
                });
            } else if (hour < 15) {
                recommendations.push({
                    type: '점심 추천',
                    text: '백종원의 본가 런치 특선이 좋은 선택입니다',
                    confidence: 88,
                    reason: '시간대 기반'
                });
            } else {
                recommendations.push({
                    type: '저녁 추천',
                    text: '화촌 삼겹살이 저녁 시간대 인기 1위입니다',
                    confidence: 95,
                    reason: '시간대 기반'
                });
            }
            
            // Trending-based recommendations
            const trendingRestaurants = restaurants.filter(r => r.trending);
            if (trendingRestaurants.length > 0) {
                const trending = trendingRestaurants[0];
                recommendations.push({
                    type: '트렌딩',
                    text: `${trending.name}이(가) 현재 가장 핫한 맛집입니다`,
                    confidence: trending.socialScore,
                    reason: '실시간 트렌드'
                });
            }
            
            // Weather-based recommendations (mock)
            const weatherConditions = ['맑음', '흐림', '비', '눈'];
            const weather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
            
            if (weather === '비' || weather === '눈') {
                recommendations.push({
                    type: '날씨 추천',
                    text: '오늘같은 날엔 따뜻한 국물요리가 좋습니다',
                    confidence: 85,
                    reason: '날씨 기반'
                });
            }
            
            // User preference based
            if (userPreferences.favoriteCategory) {
                const categoryRestaurants = restaurants.filter(r => r.category === userPreferences.favoriteCategory);
                if (categoryRestaurants.length > 0) {
                    recommendations.push({
                        type: '맞춤 추천',
                        text: `선호하시는 ${userPreferences.favoriteCategory} 카테고리의 맛집을 추천드립니다`,
                        confidence: 90,
                        reason: '사용자 선호도'
                    });
                }
            }
            
            const container = document.getElementById('ai-recommendations');
            container.innerHTML = '';
            
            recommendations.forEach((rec, index) => {
                const recElement = document.createElement('div');
                recElement.className = 'bg-purple-900 bg-opacity-50 p-3 rounded-lg slide-in';
                recElement.style.animationDelay = `${index * 0.15}s`;
                recElement.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="px-2 py-1 bg-purple-600 text-white text-xs rounded-full">${rec.type}</span>
                                <span class="text-xs text-gray-300">${rec.confidence}% 신뢰도</span>
                            </div>
                            <p class="text-sm">${rec.text}</p>
                            <p class="text-xs text-gray-400 mt-1">${rec.reason}</p>
                        </div>
                        <i class="fas fa-robot text-purple-400"></i>
                    </div>
                `;
                container.appendChild(recElement);
            });
        }

        // Recent reviews section
        function updateRecentReviews() {
            const savedReviews = JSON.parse(localStorage.getItem('userReviews') || '[]');
            const container = document.getElementById('recent-reviews');
            container.innerHTML = '';
            
            // Show last 3 reviews
            const recentReviews = savedReviews.slice(-3).reverse();
            
            if (recentReviews.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400">아직 리뷰가 없습니다</p>';
                return;
            }
            
            recentReviews.forEach((review, index) => {
                const reviewElement = document.createElement('div');
                reviewElement.className = 'bg-gray-800 p-2 rounded-lg text-sm';
                reviewElement.innerHTML = `
                    <div class="flex items-start justify-between mb-1">
                        <span class="font-medium">${review.restaurant}</span>
                        <span class="text-yellow-400">${'★'.repeat(review.rating)}</span>
                    </div>
                    <p class="text-xs text-gray-300">${review.content}</p>
                    <p class="text-xs text-gray-500 mt-1">${new Date(review.date).toLocaleDateString()}</p>
                `;
                container.appendChild(reviewElement);
            });
        }

        // Review modal functions
        function openReviewModal() {
            document.getElementById('review-modal').style.display = 'block';
            
            // Populate restaurant dropdown
            const select = document.getElementById('review-restaurant');
            select.innerHTML = '<option value="">선택하세요</option>';
            
            restaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.id;
                option.textContent = restaurant.name;
                select.appendChild(option);
            });
        }

        function closeReviewModal() {
            document.getElementById('review-modal').style.display = 'none';
            
            // Reset form
            document.getElementById('review-restaurant').value = '';
            document.getElementById('review-content').value = '';
            selectedRating = 0;
            document.querySelectorAll('.star').forEach(star => {
                star.classList.remove('active');
            });
        }

        // Star rating setup
        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.getAttribute('data-rating'));
                    
                    stars.forEach((s, index) => {
                        if (index < selectedRating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
                
                star.addEventListener('mouseenter', () => {
                    const hoverRating = parseInt(star.getAttribute('data-rating'));
                    
                    stars.forEach((s, index) => {
                        if (index < hoverRating) {
                            s.style.color = '#ffd700';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
            
            document.getElementById('star-rating').addEventListener('mouseleave', () => {
                stars.forEach((s, index) => {
                    if (index < selectedRating) {
                        s.style.color = '#ffd700';
                    } else {
                        s.style.color = '#ddd';
                    }
                });
            });
        }

        // Submit review
        function submitReview() {
            const restaurantId = document.getElementById('review-restaurant').value;
            const content = document.getElementById('review-content').value;
            
            if (!restaurantId || !content || selectedRating === 0) {
                alert('모든 항목을 입력해주세요.');
                return;
            }
            
            const restaurant = restaurants.find(r => r.id == restaurantId);
            
            const review = {
                id: Date.now(),
                restaurant: restaurant.name,
                restaurantId: restaurantId,
                rating: selectedRating,
                content: content,
                date: new Date().toISOString()
            };
            
            // Save to localStorage
            const savedReviews = JSON.parse(localStorage.getItem('userReviews') || '[]');
            savedReviews.push(review);
            localStorage.setItem('userReviews', JSON.stringify(savedReviews));
            
            // Update restaurant's user reviews
            restaurant.userReviews.push(review);
            
            // Recalculate rating
            const totalRating = (restaurant.rating * restaurant.reviews) + selectedRating;
            restaurant.reviews++;
            restaurant.rating = (totalRating / restaurant.reviews).toFixed(1);
            
            // If offline, save for later sync
            if (!navigator.onLine) {
                const pendingReviews = JSON.parse(localStorage.getItem('pendingReviews') || '[]');
                pendingReviews.push(review);
                localStorage.setItem('pendingReviews', JSON.stringify(pendingReviews));
                
                // Register background sync
                if ('serviceWorker' in navigator && 'SyncManager' in window) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.sync.register('sync-reviews');
                    });
                }
            }
            
            // Update UI
            updateRecentReviews();
            closeReviewModal();
            showNotification('리뷰가 등록되었습니다!');
        }

        // Load saved reviews
        function loadSavedReviews() {
            const savedReviews = JSON.parse(localStorage.getItem('userReviews') || '[]');
            
            savedReviews.forEach(review => {
                const restaurant = restaurants.find(r => r.id == review.restaurantId);
                if (restaurant) {
                    restaurant.userReviews.push(review);
                }
            });
        }

        // Change language
        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // Update language buttons
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.className = 'language-btn px-2 py-1 text-xs bg-gray-600 text-white rounded';
            });
            
            const langButtons = {
                'ko': 0, 'en': 1, 'ja': 2, 'zh': 3, 'th': 4, 'vi': 5
            };
            
            document.querySelectorAll('.language-btn')[langButtons[lang]].className = 'language-btn px-2 py-1 text-xs bg-blue-500 text-white rounded';
            
            // Update text content
            const texts = translations[lang];
            if (texts) {
                Object.keys(texts).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (key === 'search-placeholder') {
                            element.placeholder = texts[key];
                        } else {
                            element.textContent = texts[key];
                        }
                    }
                });
            }
            
            // Save preference
            localStorage.setItem('language', lang);
            
            // Update map markers
            updateMapMarkers();
        }

        // Filter restaurants
        function filterRestaurants() {
            const filter = document.getElementById('filter-select').value;
            
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Filter restaurants
            const filteredRestaurants = filter === 'all' 
                ? restaurants 
                : restaurants.filter(r => r.category === filter);
            
            // Add filtered markers
            filteredRestaurants.forEach(restaurant => {
                addMarkerToMap(restaurant);
            });
            
            // Save preference
            const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
            preferences.lastFilter = filter;
            localStorage.setItem('userPreferences', JSON.stringify(preferences));
        }

        // Refresh data with enhanced updates
        function refreshData() {
            // Show loading indicator
            document.getElementById('loading-indicator').style.display = 'block';
            
            // Simulate API calls with more dynamic data updates
            restaurants.forEach(restaurant => {
                // More realistic social score changes
                const change = Math.floor(Math.random() * 10) - 5;
                restaurant.socialScore += change;
                restaurant.socialScore = Math.max(0, Math.min(100, restaurant.socialScore));
                
                // Dynamic trending based on score changes
                restaurant.trending = restaurant.socialScore > 80 || Math.random() > 0.7;
                
                // Simulate new reviews
                if (Math.random() > 0.8) {
                    restaurant.reviews += Math.floor(Math.random() * 5);
                    restaurant.rating = (restaurant.rating + (Math.random() * 0.2 - 0.1)).toFixed(1);
                    restaurant.rating = Math.max(3.5, Math.min(5.0, parseFloat(restaurant.rating)));
                }
                
                restaurant.lastUpdate = Date.now();
            });
            
            // Update UI
            setTimeout(() => {
                updateMapMarkers();
                updateTopRestaurants();
                updateSocialFeed();
                updateAIRecommendations();
                document.getElementById('loading-indicator').style.display = 'none';
                
                // Show update notification
                showUpdateBadge();
            }, 1500);
        }

        // Check for updates
        function checkForUpdates() {
            // Simulate checking for new data
            const hasUpdates = Math.random() > 0.5;
            
            if (hasUpdates) {
                showUpdateBadge();
                
                // Show notification if permission granted
                if (Notification.permission === 'granted') {
                    new Notification('신오쿠보 스마트 가이드', {
                        body: '새로운 맛집 정보가 업데이트되었습니다!',
                        icon: '/icon-192.png'
                    });
                }
            }
        }

        // Show update badge
        function showUpdateBadge() {
            const badge = document.getElementById('update-badge');
            badge.style.display = 'flex';
            
            setTimeout(() => {
                badge.style.display = 'none';
            }, 5000);
        }

        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-2000';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // PWA installation
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            const installBtn = document.createElement('button');
            installBtn.textContent = '앱 설치';
            installBtn.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-full shadow-lg z-1000';
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        installBtn.remove();
                    }
                    deferredPrompt = null;
                });
            });
            document.body.appendChild(installBtn);
        });
    </script>
</body>
</html>